name: Unit Tests

on:
  pull_request:
    branches: ["main", "master"]

permissions:
  pull-requests: write
  contents: read

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.4"

      - name: Run tests and generate coverage
        run: |
          go test ./... -coverprofile=coverage.out -covermode=atomic

      - name: Extract total and individual coverage
        id: coverage
        run: |
          # Total coverage
          TOTAL=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')

          # Per-file coverage formatted
          FILES=$(go tool cover -func=coverage.out | grep -v "total:" | awk '{gsub("github.com/Jinish9302/GoRateLimiter/", "", $1); printf "- %s: %s\n", $1, $3}')

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or Update PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const commentIdentifier = "<!-- coverage-comment -->";

            const total = "${{ steps.coverage.outputs.total }}";
            const files = `${{ steps.coverage.outputs.files }}`;

            const body = `
            ${commentIdentifier}
            ### ðŸ“Š Go Test Coverage Report

            **Total Coverage:** ${total}

            **Per-File Coverage**
            | File | Coverage |
            |------|----------|
            ${files.split('\n').map(file => `| ${file.trim().split(':: ')[0].replace("- ", "").trim()} | ${file.trim().split(':: ')[1].trim()} |`).join('\n')}
            `;

            // Get existing comments
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });

            // Check if comment already exists
            const existing = comments.data.find(c => c.body.includes(commentIdentifier));

            if (existing) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body
              });
            }
